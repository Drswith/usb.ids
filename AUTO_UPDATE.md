# 自动更新工作流

本项目配置了GitHub Actions自动更新工作流，用于定期检查和更新USB.IDS数据。

## 🕐 执行时间

- **定时执行**: 每天UTC 0点（北京时间上午8点）
- **手动触发**: 可在GitHub Actions页面手动执行

## 🔄 工作流程

### 1. 数据检查
- 获取当前版本的内容哈希值
- 从远程源下载最新的USB.IDS数据
- 计算新数据的哈希值
- 比较哈希值判断是否有更新

### 2. 版本更新（仅在数据变化时）
- 自动增加package.json中的patch版本号
- 重新生成版本信息文件
- 构建项目

### 3. 发布流程（仅在数据变化时）
- 提交所有变更到git仓库
- 创建新的git标签
- 推送到GitHub仓库
- 创建GitHub Release
- 发布到npm

## 📋 工作流文件

工作流配置文件位于：`.github/workflows/auto-update.yml`

### 主要步骤

1. **环境准备**
   - 检出代码仓库
   - 设置Node.js和pnpm环境
   - 安装项目依赖

2. **数据检查**
   - 读取当前版本信息
   - 强制获取最新USB.IDS数据
   - 比较内容哈希值

3. **条件更新**
   - 仅在数据变化时执行后续步骤
   - 自动增加版本号
   - 重新构建项目

4. **发布流程**
   - 提交变更并创建标签
   - 创建GitHub Release
   - 发布到npm仓库

## 🔧 本地测试

可以使用以下命令在本地测试更新检查逻辑：

```bash
# 检查是否有新数据可用
npm run check-update
```

**退出码说明**：
- `0`: 检测到数据更新
- `1`: 数据无变化，无需更新
- `2`: 检查过程中出现错误

## 🛡️ 安全考虑

### 所需权限
- `contents: write` - 用于提交代码和创建标签
- `pull-requests: write` - 用于创建PR（如需要）
- `id-token: write` - 用于身份验证

### 所需密钥
- `GITHUB_TOKEN` - GitHub自动提供，用于仓库操作
- `NPM_TOKEN` - 需要在仓库设置中配置，用于发布到npm

## 📊 监控和日志

### 成功执行
当检测到数据更新时，工作流会：
- 在Actions页面显示成功状态
- 创建新的GitHub Release
- 发布新版本到npm
- 在Summary中显示版本信息

### 无需更新
当数据无变化时，工作流会：
- 正常完成执行
- 在Summary中显示"无需更新"信息
- 不执行任何发布操作

### 错误处理
如果执行过程中出现错误：
- 工作流会标记为失败
- 错误信息会显示在Actions日志中
- 不会执行任何发布操作

## 🔄 手动触发

除了定时执行外，还可以手动触发工作流：

1. 访问GitHub仓库的Actions页面
2. 选择"Auto Update USB.IDS"工作流
3. 点击"Run workflow"按钮
4. 选择分支（通常是main）
5. 点击"Run workflow"确认执行

## 📝 版本号规则

自动更新使用以下版本号规则：
- 版本号格式：`v1.0.{时间戳}`
- 前两位固定为 `1.0`，第三位为获取数据时的Unix毫秒时间戳
- 时间戳确保版本号的唯一性和时间顺序

例如：
- USB.IDS版本：`v1.0.1756665123456`

## 🚨 注意事项

1. **npm发布权限**：确保配置了正确的`NPM_TOKEN`
2. **分支保护**：如果main分支有保护规则，需要相应调整
3. **频率限制**：避免过于频繁的手动触发
4. **依赖更新**：定期检查GitHub Actions依赖的版本

## 🔍 故障排除

### 常见问题

1. **npm发布失败**
   - 检查NPM_TOKEN是否正确配置
   - 确认npm包名没有冲突
   - 验证版本号是否符合semver规范

2. **git推送失败**
   - 检查GITHUB_TOKEN权限
   - 确认分支保护规则设置
   - 验证提交信息格式

3. **数据获取失败**
   - 检查网络连接
   - 验证USB.IDS源URL可访问性
   - 查看详细错误日志

### 调试步骤

1. 查看Actions执行日志
2. 检查各步骤的输出信息
3. 验证环境变量和密钥配置
4. 在本地复现问题（使用check-update脚本）
